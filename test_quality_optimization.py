#!/usr/bin/env python3
"""
Quality Optimization Test
Testet verschiedene Einstellungen f√ºr bessere Druckqualit√§t
"""

import requests
import time
from PIL import Image, ImageDraw, ImageFont
import io

BASE_URL = "http://localhost:8080"

def create_quality_test_pattern() -> bytes:
    """Erstellt Test-Pattern f√ºr Qualit√§ts-Bewertung"""
    width, height = 320, 240
    img = Image.new('RGB', (width, height), 'white')
    draw = ImageDraw.Draw(img)
    
    # Verschiedene Test-Pattern f√ºr Qualit√§ts-Bewertung
    
    # 1. Feine horizontale Linien (Drift-Test)
    for y in range(20, 80, 2):
        draw.line([10, y, width-10, y], fill='black', width=1)
    draw.text((15, 85), "HORIZONTAL LINES - CHECK ALIGNMENT", fill='black')
    
    # 2. Vertikale Linien (Konsistenz-Test)
    for x in range(20, 120, 4):
        draw.line([x, 100, x, 140], fill='black', width=1)
    draw.text((15, 145), "VERTICAL LINES - CHECK CONSISTENCY", fill='black')
    
    # 3. Diagonal-Pattern (Qualit√§ts-Test)
    for i in range(0, 80, 4):
        draw.line([140+i, 100, 140+i+20, 120], fill='black', width=1)
        draw.line([140+i+20, 120, 140+i+40, 100], fill='black', width=1)
    draw.text((145, 125), "DIAGONAL - CHECK QUALITY", fill='black')
    
    # 4. Text-Sch√§rfe-Test
    draw.text((10, 160), "TEXT SHARPNESS TEST:", fill='black')
    draw.text((10, 175), "ABCDEFGHIJKLMNOPQRSTUVWXYZ", fill='black')
    draw.text((10, 190), "1234567890 !@#$%^&*()", fill='black')
    
    # 5. Rahmen f√ºr Position-Referenz
    draw.rectangle([0, 0, width-1, height-1], outline='black', width=2)
    draw.rectangle([5, 5, width-6, height-6], outline='black', width=1)
    
    # Position-Markierungen
    draw.text((10, 10), "TOP-LEFT", fill='black')
    draw.text((width-70, 10), "TOP-RIGHT", fill='black')
    draw.text((10, height-25), "BOTTOM-LEFT", fill='black')
    draw.text((width-90, height-25), "BOTTOM-RIGHT", fill='black')
    
    buffer = io.BytesIO()
    img.save(buffer, format='PNG')
    return buffer.getvalue()

def test_quality_settings():
    """Testet verschiedene Qualit√§ts-Einstellungen"""
    print("üéØ QUALITY OPTIMIZATION TEST")
    print("=" * 60)
    print("üìã Testet optimierte Einstellungen f√ºr bessere Druckqualit√§t")
    print("üîß Ohne extra Zeilen, mit verbesserter √úbertragung")
    print("=" * 60)
    
    # Test 1: Standard-Qualit√§ts-Test
    print("\n1Ô∏è‚É£ QUALIT√ÑTS-TEST: Standard-Pattern")
    test_standard_quality()
    
    # Test 2: Verschiedene Dithering-Einstellungen
    print("\n2Ô∏è‚É£ DITHERING-TEST: Verschiedene Einstellungen")
    test_dithering_settings()
    
    # Test 3: Verschiedene Skalierungs-Modi
    print("\n3Ô∏è‚É£ SKALIERUNGS-TEST: Verschiedene Modi")
    test_scaling_modes()

def test_standard_quality():
    """Standard-Qualit√§ts-Test mit dem optimierten Pattern"""
    try:
        print("   üé® Erstelle Qualit√§ts-Test-Pattern...")
        test_image = create_quality_test_pattern()
        
        print("   üì§ Sende mit optimierten Einstellungen...")
        files = {'data': ('quality_test.png', test_image, 'image/png')}
        data = {
            'use_queue': 'false',
            'fit_to_label': 'true',
            'maintain_aspect': 'true',
            'dither': 'true'
        }
        
        start_time = time.time()
        response = requests.post(f"{BASE_URL}/api/print-image", files=files, data=data)
        end_time = time.time()
        
        result = response.json()
        
        if result['success']:
            print(f"   ‚úÖ Qualit√§ts-Test erfolgreich ({end_time-start_time:.2f}s)")
            print("   üìã QUALIT√ÑTS-BEWERTUNG:")
            print("       ‚Ä¢ Horizontale Linien gerade und ausgerichtet?")
            print("       ‚Ä¢ Vertikale Linien gleichm√§√üig?")
            print("       ‚Ä¢ Diagonale sauber und scharf?")
            print("       ‚Ä¢ Text scharf und lesbar?")
            print("       ‚Ä¢ Rahmen korrekt positioniert?")
            print("       ‚Ä¢ KEINE extra Zeilen am Ende?")
            
            quality_rating = input("   üìä Qualit√§ts-Bewertung (1-10, 10=perfekt): ")
            if quality_rating.isdigit():
                rating = int(quality_rating)
                if rating >= 8:
                    print("   üéâ EXCELLENT! Qualit√§t ist sehr gut")
                elif rating >= 6:
                    print("   üëç GOOD! Qualit√§t ist akzeptabel")
                    suggest_quality_improvements()
                else:
                    print("   üòû NEEDS IMPROVEMENT! Weitere Optimierung n√∂tig")
                    suggest_quality_improvements()
        else:
            print(f"   ‚ùå Qualit√§ts-Test fehlgeschlagen: {result['error']}")
            
    except Exception as e:
        print(f"   ‚ùå Qualit√§ts-Test Fehler: {e}")

def test_dithering_settings():
    """Testet verschiedene Dithering-Einstellungen"""
    dithering_tests = [
        ('Dithering AN, Standard', {'dither': 'true'}),
        ('Dithering AUS, Threshold', {'dither': 'false', 'dither_threshold': '128'}),
        ('Hoher Kontrast', {'dither': 'true', 'contrast_boost': '1.5'}),
        ('Schwacher Kontrast', {'dither': 'true', 'contrast_boost': '0.8'})
    ]
    
    test_image = create_quality_test_pattern()
    
    for i, (name, settings) in enumerate(dithering_tests, 1):
        try:
            print(f"   {i}. {name}...")
            
            files = {'data': ('dither_test.png', test_image, 'image/png')}
            data = {
                'use_queue': 'false',
                'fit_to_label': 'true',
                **settings
            }
            
            response = requests.post(f"{BASE_URL}/api/print-image", files=files, data=data)
            result = response.json()
            
            if result['success']:
                print(f"      ‚úÖ {name} erfolgreich")
                quality = input(f"      üìä Qualit√§t von {name} (1-10): ")
                print(f"      üìù Bewertung: {quality}/10")
            else:
                print(f"      ‚ùå {name} fehlgeschlagen")
            
            time.sleep(2)  # Pause zwischen Tests
            
        except Exception as e:
            print(f"      ‚ùå {name} Fehler: {e}")

def test_scaling_modes():
    """Testet verschiedene Skalierungs-Modi"""
    scaling_tests = [
        ('Fit Aspect (Standard)', {'scaling_mode': 'fit_aspect'}),
        ('Crop Center', {'scaling_mode': 'crop_center'}),
        ('Pad Center', {'scaling_mode': 'pad_center'}),
        ('Stretch Full', {'scaling_mode': 'stretch_full'})
    ]
    
    test_image = create_quality_test_pattern()
    
    for i, (name, settings) in enumerate(scaling_tests, 1):
        try:
            print(f"   {i}. {name}...")
            
            files = {'data': ('scaling_test.png', test_image, 'image/png')}
            data = {
                'use_queue': 'false',
                'fit_to_label': 'true',
                'dither': 'true',
                **settings
            }
            
            response = requests.post(f"{BASE_URL}/api/print-image", files=files, data=data)
            result = response.json()
            
            if result['success']:
                print(f"      ‚úÖ {name} erfolgreich")
                positioning = input(f"      üìê Positionierung von {name} OK? (y/N): ")
                if positioning.lower() == 'y':
                    print(f"      üéØ {name} - Positionierung OK")
                else:
                    print(f"      ‚ö†Ô∏è {name} - Positionierung problematisch")
            else:
                print(f"      ‚ùå {name} fehlgeschlagen")
            
            time.sleep(2)  # Pause zwischen Tests
            
        except Exception as e:
            print(f"      ‚ùå {name} Fehler: {e}")

def suggest_quality_improvements():
    """Vorschl√§ge f√ºr weitere Qualit√§ts-Verbesserungen"""
    print("\nüîß QUALIT√ÑTS-VERBESSERUNGS-VORSCHL√ÑGE:")
    print("1. Chunk-Gr√∂√üe anpassen:")
    print("   ‚Ä¢ Kleinere Chunks (64-96) f√ºr bessere Pr√§zision")
    print("   ‚Ä¢ Gr√∂√üere Chunks (192-256) f√ºr bessere Geschwindigkeit")
    
    print("\n2. Timing-Optimierung:")
    print("   ‚Ä¢ L√§ngere Pausen: 0.02-0.05s zwischen Chunks")
    print("   ‚Ä¢ K√ºrzere Pausen: 0.005-0.01s f√ºr schnellere √úbertragung")
    
    print("\n3. Bildverarbeitung:")
    print("   ‚Ä¢ Andere Dithering-Einstellungen")
    print("   ‚Ä¢ Kontrast-Anpassung")
    print("   ‚Ä¢ Aufl√∂sungs-Optimierung")
    
    print("\n4. Hardware-Checks:")
    print("   ‚Ä¢ Bluetooth-Signalst√§rke pr√ºfen")
    print("   ‚Ä¢ Drucker-Position stabilisieren")
    print("   ‚Ä¢ Label-Qualit√§t √ºberpr√ºfen")

def quick_drift_check():
    """Schneller Drift-Check mit einfachem Muster"""
    try:
        print("   üîç Quick Drift Check...")
        
        # Einfaches Drift-Test-Muster
        width, height = 200, 100
        img = Image.new('RGB', (width, height), 'white')
        draw = ImageDraw.Draw(img)
        
        # Nur horizontale Linien f√ºr Drift-Erkennung
        for y in range(10, height-10, 10):
            draw.line([5, y, width-5, y], fill='black', width=2)
            draw.text((10, y-8), f"LINE {y}", fill='black')
        
        buffer = io.BytesIO()
        img.save(buffer, format='PNG')
        test_image = buffer.getvalue()
        
        files = {'data': ('drift_check.png', test_image, 'image/png')}
        data = {'use_queue': 'false', 'fit_to_label': 'true', 'dither': 'true'}
        
        response = requests.post(f"{BASE_URL}/api/print-image", files=files, data=data)
        result = response.json()
        
        if result['success']:
            print("   ‚úÖ Drift-Check gedruckt")
            drift_status = input("   ‚ùì Drift sichtbar? (y/N): ")
            if drift_status.lower() == 'y':
                print("   ‚ùå DRIFT WEITERHIN VORHANDEN")
                return False
            else:
                print("   ‚úÖ KEIN DRIFT ERKENNBAR")
                return True
        else:
            print(f"   ‚ùå Drift-Check fehlgeschlagen: {result['error']}")
            return False
            
    except Exception as e:
        print(f"   ‚ùå Drift-Check Fehler: {e}")
        return False

if __name__ == "__main__":
    print("üéØ QUALITY OPTIMIZATION TESTER")
    print("üîß Optimiert f√ºr: Keine extra Zeilen + Bessere Qualit√§t")
    print()
    
    # Erst schneller Drift-Check
    print("üîç QUICK DRIFT CHECK:")
    drift_ok = quick_drift_check()
    
    if drift_ok:
        print("\nüéØ DRIFT OK - Starte Qualit√§ts-Tests...")
        test_quality_settings()
    else:
        print("\n‚ö†Ô∏è DRIFT PROBLEM - Qualit√§ts-Tests √ºbersprungen")
        print("üí° L√∂se erst das Drift-Problem, dann Qualit√§ts-Optimierung")
    
    print("\nüéâ Quality Optimization Test abgeschlossen!")
